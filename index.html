<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>MV STUDIO PRO - JITSI CLEAN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
    <style>
        :root { --main: #ffaa00; --msg-size: 26px; } 
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; background: #000; overflow: hidden; color: white; font-family: sans-serif; }
        
        #viewport { position: relative; width: 100%; height: calc(100% - 130px); background: #000; overflow: hidden; }
        #bg-v, #bg-i, #bg-s { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none; z-index: 1; }
        
        /* Jitsi ASCUNS - RuleazƒÉ √Æn spate dar nu se vede */
        #jitsi-wrap { position: absolute; top: -5000px; left: -5000px; width: 1px; height: 1px; opacity: 0; pointer-events: none; }

        #cam-box { position: absolute; z-index: 10; cursor: move; display: none; top: 20%; left: 35%; }
        #ai-canvas { width: 450px; border-radius: 10px; }
        
        #circle-box { position: absolute; z-index: 15; cursor: move; width: 220px; height: 220px; top: 10%; right: 10%; }
        #radial-canvas { position: absolute; z-index: 16; pointer-events: none; }
        #inner-circle { width: 90px; height: 90px; border-radius: 50%; border: 2px solid #fff; background: #000; overflow: hidden; z-index: 17; display: flex; align-items: center; justify-content: center; position: absolute; top: 65px; left: 65px; }
        #inner-img { width: 100%; height: 100%; object-fit: cover; display: none; }

        #branding { position: absolute; z-index: 20; cursor: move; font-weight: 900; text-transform: uppercase; bottom: 40px; left: 40px; font-size: 45px; color: white; text-shadow: 2px 2px 15px rgba(0,0,0,0.8); }
        #msg-box { position: absolute; z-index: 999; background: rgba(0, 0, 0, 0.9); border-left: 5px solid var(--main); padding: 12px; min-width: 300px; cursor: move; display: none; top: 50px; left: 50px; border-radius: 0 15px 15px 0; }

        #controls { position: absolute; bottom: 0; width: 100%; height: 130px; background: #0a0a0a; display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; padding: 5px; border-top: 2px solid #222; z-index: 1000; }
        .panel { background: #151515; padding: 5px; border-radius: 6px; border: 1px solid #222; display: flex; flex-direction: column; justify-content: space-between; }
        .panel h3 { font-size: 8px; color: #ffaa00; text-align: center; font-weight: 800; border-bottom: 1px solid #333; margin-bottom: 4px; padding-bottom: 2px; }
        
        .btn { width: 100%; padding: 6px; font-weight: bold; border-radius: 4px; text-transform: uppercase; font-size: 8px; cursor: pointer; border: none; transition: 0.2s; }
        .st-off { background: #2a1010; color: #ff4444; }
        .st-on { background: #102a10; color: #44ff44; }
        .btn-blue { background: #1e40af; color: white; }
        
        .s-group { display: flex; align-items: center; gap: 5px; width: 100%; }
        label { font-size: 7px; color: #777; font-weight: bold; min-width: 40px; }
        input[type="range"] { flex: 1; height: 4px; accent-color: #ffaa00; cursor: pointer; }
        input[type="text"] { background: #000; color: #fff; border: 1px solid #333; font-size: 11px; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="viewport">
    <video id="bg-v" autoplay loop muted></video>
    <img id="bg-i">
    <img id="bg-s">
    <div id="cam-box"><canvas id="ai-canvas"></canvas></div>

    <div id="jitsi-wrap">
        <iframe id="jitsi-frame" src="https://meet.jit.si/mvstudio" allow="camera;microphone;display-capture"></iframe>
    </div>

    <div id="circle-box">
        <canvas id="radial-canvas" width="220" height="220"></canvas>
        <div id="inner-circle"><img id="inner-img"></div>
    </div>
    
    <div id="branding">MV STUDIO</div>
    
    <div id="msg-box">
        <span id="msg-user" style="color:var(--main); font-weight:bold; font-size:12px;">MESAJE LIVE</span><br>
        <span id="msg-txt" style="font-size:var(--msg-size);">A»ôteptƒÉm mesaje...</span>
    </div>
</div>

<div id="controls">
    <div class="panel">
        <h3>1. VIDEO FUNDAL</h3>
        <button id="btn-v" class="btn st-off" onclick="tgL('bg-v', 'btn-v')">VIDEO: OFF</button>
        <button class="btn bg-zinc-800" onclick="document.getElementById('up-v').click()">üìÅ UPLOAD MP4</button>
        <input type="file" id="up-v" class="hidden" onchange="loadM(this, 'bg-v', 'btn-v')">
    </div>
    
    <div class="panel">
        <h3>2. FOTO FUNDAL</h3>
        <button id="btn-i" class="btn st-off" onclick="tgL('bg-i', 'btn-i')">FOTO: OFF</button>
        <button class="btn bg-zinc-800" onclick="document.getElementById('up-i').click()">üñºÔ∏è UPLOAD JPG</button>
        <input type="file" id="up-i" class="hidden" onchange="loadM(this, 'bg-i', 'btn-i')">
    </div>
    
    <div class="panel">
        <h3>3. SLIDESHOW</h3>
        <button id="btn-s" class="btn st-off" onclick="tgL('bg-s', 'btn-s')">SLIDES: OFF</button>
        <div class="s-group"><label>SEC</label><input type="range" min="1" max="10" value="3" id="s-spd"></div>
        <button class="btn bg-zinc-800" onclick="document.getElementById('up-sld').click()">üìÇ FOLDER</button>
        <input type="file" id="up-sld" class="hidden" webkitdirectory directory multiple onchange="loadFld(this)">
    </div>
    
    <div class="panel">
        <h3>4. JITSI AI</h3>
        <button class="btn btn-blue" onclick="startAI()">1. CONECTEAZƒÇ AI</button>
        <button id="btn-cam" class="btn st-off" onclick="tgC()">2. VIEW: OFF</button>
        <div class="s-group"><label>ZOOM</label><input type="range" min="200" max="1000" value="450" oninput="document.getElementById('ai-canvas').style.width=this.value+'px'"></div>
    </div>
    
    <div class="panel">
        <h3>5. VUMETRU / LOGO</h3>
        <button id="btn-png" class="btn st-off" onclick="tgP()">LOGO: OFF</button>
        <div class="s-group"><label>SENS</label><input type="range" min="1" max="30" value="15" id="v-sens"></div>
        <button class="btn bg-zinc-800" onclick="document.getElementById('up-logo').click()">‚¨ÜÔ∏è PNG</button>
        <input type="file" id="up-logo" class="hidden" onchange="loadP(this)">
    </div>
    
    <div class="panel">
        <h3>6. SISTEM</h3>
        <input type="text" id="brand-in" placeholder="TEXT ECRAN..." oninput="document.getElementById('branding').innerText=this.value">
        <div class="s-group"><label>SIZE</label><input type="range" min="15" max="80" value="26" oninput="document.documentElement.style.setProperty('--msg-size', this.value+'px')"></div>
        <button class="btn btn-blue" onclick="goFS()">FULL SCREEN</button>
    </div>
</div>

<script>
    const app = firebase.initializeApp({ databaseURL: "https://felicitari-nunta-default-rtdb.firebaseio.com" });
    const dbMessages = app.database().ref('test_dj');
    let sFiles=[], sIdx=0, sTim, mTim, startupTime = Date.now();

    function listenMsgs() {
        dbMessages.limitToLast(1).on('child_added', sn => {
            const d = sn.val(); if(d.timestamp < startupTime) return;
            const box = document.getElementById('msg-box');
            document.getElementById('msg-user').innerText = (d.author || "INVITAT").toUpperCase();
            document.getElementById('msg-txt').innerText = `"${d.text}"`;
            box.style.display = 'block';
            if(mTim) clearTimeout(mTim);
            mTim = setTimeout(() => { box.style.display = 'none'; }, 8000);
        });
    }

    function loadM(input, id, bId) { const f = input.files[0]; if(!f) return; const url = URL.createObjectURL(f); const el = document.getElementById(id); if(id === 'bg-v') { el.src = url; el.play(); } else { el.src = url; } tgL(id, bId); }
    function loadFld(i) { sFiles = Array.from(i.files).map(f => URL.createObjectURL(f)); sIdx = 0; tgL('bg-s', 'btn-s'); }
    function tgL(id, bId) {
        document.querySelectorAll('#bg-v,#bg-i,#bg-s').forEach(e => e.style.display='none');
        document.querySelectorAll('#btn-v,#btn-i,#btn-s').forEach(b => { b.className='btn st-off'; b.innerText = b.innerText.split(':')[0] + ': OFF'; });
        if(sTim) clearTimeout(sTim);
        document.getElementById(id).style.display = 'block';
        const activeBtn = document.getElementById(bId);
        activeBtn.className = 'btn st-on'; activeBtn.innerText = activeBtn.innerText.split(':')[0] + ': ON';
        if(id === 'bg-s') startS();
    }
    function startS() { if(!sFiles.length) return; document.getElementById('bg-s').src = sFiles[sIdx]; sIdx=(sIdx+1)%sFiles.length; sTim=setTimeout(startS, document.getElementById('s-spd').value*1000); }
    function loadP(i) { document.getElementById('inner-img').src = URL.createObjectURL(i.files[0]); document.getElementById('inner-img').style.display = 'block'; document.getElementById('btn-png').className = 'btn st-on'; document.getElementById('btn-png').innerText="LOGO: ON"; }
    function tgP() { let e=document.getElementById('inner-img'), b=document.getElementById('btn-png'); e.style.display = e.style.display==='none'?'block':'none'; b.className = e.style.display==='block'?'btn st-on':'btn st-off'; b.innerText = e.style.display==='block'?"LOGO: ON":"LOGO: OFF"; }
    function tgC() { let b=document.getElementById('cam-box'), btn=document.getElementById('btn-cam'); b.style.display = b.style.display==='block'?'none':'block'; btn.className = b.style.display==='block'?'btn st-on':'btn st-off'; btn.innerText = b.style.display==='block'?"VIEW: ON":"VIEW: OFF"; }

    const selfie = new SelfieSegmentation({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
    selfie.setOptions({modelSelection: 1});
    selfie.onResults(r => {
        const can = document.getElementById('ai-canvas'), ctx = can.getContext('2d');
        can.width = r.image.width; can.height = r.image.height;
        ctx.save(); ctx.clearRect(0,0,can.width,can.height);
        ctx.drawImage(r.segmentationMask, 0,0,can.width,can.height);
        ctx.globalCompositeOperation = 'source-in';
        ctx.drawImage(r.image, 0,0,can.width,can.height); ctx.restore();
    });

    async function startAI() {
        try {
            const s = await navigator.mediaDevices.getDisplayMedia({video: {cursor: "never"}, audio: true});
            const v = document.createElement('video'); v.srcObject = s; v.play();
            const pred = async () => { await selfie.send({image: v}); requestAnimationFrame(pred); }; pred();
            initVu(s); listenMsgs();
        } catch(e) { console.log("User cancelled or error"); }
    }

    function initVu(s) {
        const c = document.getElementById('radial-canvas').getContext('2d');
        const actx = new AudioContext(), src = actx.createMediaStreamSource(s), ans = actx.createAnalyser();
        ans.fftSize = 256; const d = new Uint8Array(ans.frequencyBinCount); src.connect(ans);
        function drw() { 
            requestAnimationFrame(drw); ans.getByteFrequencyData(d); c.clearRect(0,0,220,220); 
            let sens = document.getElementById('v-sens').value / 8; c.strokeStyle = "#ffffff"; c.lineWidth = 3; 
            for(let i=0; i<60; i++){ 
                let a = (i*6)*Math.PI/180, l = d[i] * 0.3 * sens; 
                c.beginPath(); c.moveTo(110+Math.cos(a)*50, 110+Math.sin(a)*50); 
                c.lineTo(110+Math.cos(a)*(50+l), 110+Math.sin(a)*(50+l)); c.stroke(); 
            } 
        } drw();
    }

    function goFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
    
    function drag(e) {
        let p1=0, p2=0, p3=0, p4=0;
        e.onmousedown = m => { if(m.target.tagName==='INPUT'||m.target.tagName==='BUTTON')return; p3=m.clientX; p4=m.clientY; document.onmouseup = () => { document.onmouseup=null; document.onmousemove=null; }; document.onmousemove = m => { p1=p3-m.clientX; p2=p4-m.clientY; p3=m.clientX; p4=m.clientY; e.style.top=(e.offsetTop-p2)+"px"; e.style.left=(e.offsetLeft-p1)+"px"; }; };
    }
    [document.getElementById('circle-box'), document.getElementById('cam-box'), document.getElementById('branding'), document.getElementById('msg-box')].forEach(drag);
</script>
</body>
</html>
