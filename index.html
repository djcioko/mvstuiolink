<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>MV STUDIO - NINJA AI MIXER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; background: #000; overflow: hidden; color: white; font-family: sans-serif; }
        #viewport { position: relative; width: 100%; height: calc(100% - 150px); background: #111; display: flex; align-items: center; justify-content: center; }
        #cam-box { position: absolute; z-index: 10; cursor: move; }
        #ai-canvas { width: 450px; border: 2px solid #ffaa00; background: #000; border-radius: 15px; }
        
        /* Iframe-ul Ninja - îl ținem vizibil mic pentru control, apoi îl ascundem */
        #ninja-container { position: absolute; bottom: 160px; right: 10px; width: 200px; height: 150px; border: 1px solid #333; z-index: 5; }
        #ninja-frame { width: 100%; height: 100%; border: none; }

        #controls { position: absolute; bottom: 0; width: 100%; height: 150px; background: #0a0a0a; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; border-top: 2px solid #222; }
        .panel { background: #111; border: 1px solid #333; padding: 10px; border-radius: 8px; display: flex; flex-direction: column; gap: 8px; }
        input { background: #000; border: 1px solid #444; color: #0f0; padding: 8px; font-size: 11px; border-radius: 4px; }
        .btn { padding: 10px; font-weight: bold; cursor: pointer; border: none; border-radius: 5px; text-transform: uppercase; font-size: 11px; }
        .btn-green { background: #00ff44; color: #000; }
        .btn-blue { background: #1e3a8a; color: #fff; }
    </style>
</head>
<body>

<div id="viewport">
    <div id="cam-box"><canvas id="ai-canvas"></canvas></div>
    <div id="branding" style="position:absolute; bottom:20px; left:20px; font-size:40px; font-weight:900; opacity:0.5;">MV STUDIO AI</div>
</div>

<div id="ninja-container">
    <iframe id="ninja-frame" allow="camera;microphone;fullscreen;display-capture;"></iframe>
</div>

<div id="controls">
    <div class="panel">
        <h3 style="color:#ffaa00; font-size:10px;">1. CONECTARE NINJA</h3>
        <input type="text" id="ninja-url" placeholder="Paste link-ul VDO.Ninja aici...">
        <button class="btn btn-green" onclick="loadNinja()">CONECTEAZĂ CAMERA</button>
    </div>
    
    <div class="panel">
        <h3 style="color:#ffaa00; font-size:10px;">2. CONTROL AI</h3>
        <button class="btn btn-blue" onclick="startAI()">PORNEȘTE DECUPAREA</button>
        <label style="font-size:9px;">MĂRIME</label>
        <input type="range" min="200" max="800" value="450" oninput="document.getElementById('ai-canvas').style.width=this.value+'px'">
    </div>

    <div class="panel">
        <h3 style="color:#ffaa00; font-size:10px;">3. MODALITATE</h3>
        <button class="btn btn-blue" onclick="document.documentElement.requestFullscreen()">FULL SCREEN</button>
        <button class="btn btn-blue" onclick="toggleNinja()">ASCUNDE/ARATĂ SURSA</button>
    </div>

    <div class="panel">
        <h3 style="color:#ffaa00; font-size:10px;">4. INFO</h3>
        <p style="font-size:9px; color:#666;">Pas 1: Deschide VDO.Ninja pe telefon.<br>Pas 2: Pune link-ul "view" aici.<br>Pas 3: Apasă Pornește Decuparea.</p>
    </div>
</div>

<script>
    function loadNinja() {
        let url = document.getElementById('ninja-url').value;
        if(!url.includes('autoplay')) url += "&autoplay=1&clean=1&transparent=1";
        document.getElementById('ninja-frame').src = url;
    }

    function toggleNinja() {
        const c = document.getElementById('ninja-container');
        c.style.display = c.style.display === 'none' ? 'block' : 'none';
    }

    const selfie = new SelfieSegmentation({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
    selfie.setOptions({modelSelection: 1});

    selfie.onResults(r => {
        const can = document.getElementById('ai-canvas'), ctx = can.getContext('2d');
        can.width = r.image.width; can.height = r.image.height;
        ctx.save(); ctx.clearRect(0,0,can.width,can.height);
        ctx.drawImage(r.segmentationMask, 0,0,can.width,can.height);
        ctx.globalCompositeOperation = 'source-in';
        ctx.drawImage(r.image, 0,0,can.width,can.height); ctx.restore();
    });

    async function startAI() {
        // Căutăm video-ul din interiorul Iframe-ului Ninja
        const iframe = document.getElementById('ninja-frame');
        // NOTĂ: Pentru a funcționa decuparea directă din iframe, ambele trebuie să fie pe HTTPS.
        // Dacă browserul blochează accesul la iframe, vom folosi funcția de Screen Capture pe fereastra Ninja.
        alert("AI-ul este gata. Dacă imaginea nu apare, asigură-te că link-ul Ninja este corect.");
        
        // Loop de captură
        async function detect() {
            // Încercăm să procesăm ce se vede în iframe
            // Pentru securitate, majoritatea browserelor cer ca Ninja să ruleze și el.
            // O metodă sigură: vom cere permisiune de "Window Capture"
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            const v = document.createElement('video');
            v.srcObject = stream;
            v.play();
            v.onloadedmetadata = () => {
                const run = async () => {
                    await selfie.send({image: v});
                    requestAnimationFrame(run);
                };
                run();
            };
        }
        detect();
    }
</script>
</body>
</html>
